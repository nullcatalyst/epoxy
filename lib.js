"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function t(e){return String(e).replace(/(^|-)(\w|$)/g,(e,t,s)=>s.toUpperCase())}function s(e){return t(p.parse(e).name)}function i(){return""}function n(e){return String(e)}function r(e){return String(e).replace(/[&"<>\']/g,e=>e in T?T[e]:e)}function a(e){return String(e).replace(/[`\\$]/g,e=>e in b?b[e]:e)}Object.defineProperty(exports,"__esModule",{value:!0});var o=require("events"),l=require("bluebird"),c=require("chokidar"),h=e(require("globby")),p=require("path"),u=require("fs"),_=require("sax"),g=require("html-minifier");class d{constructor(e,t,i,n){this._fileName=e,this._name=s(e),this._style=t,this._script=i,this._template=n}get fileName(){return this._fileName}get name(){return this._name}get style(){return this._style}get script(){return this._script}get template(){return this._template}}class m{constructor(e,t){this._delegate=null,this._delegates={},this._style="",this._script="",this._template=null,this._promise=new l((e,s)=>{const n=_.createStream(!0,{trim:!1,normalize:!1,lowercase:!1,xmlns:!1,position:!0});n.on("error",e=>{this.onError(e),s(e)}),n.on("opentag",e=>this.onOpenTag(e)),n.on("closetag",e=>this.onCloseTag(e)),n.on("text",e=>this.onText(e)),n.on("end",()=>{this.onEnd(),e(new d(t,this._style,this._script,this._template||i))});const r=u.createReadStream(p.resolve(t));n.write("<root>","utf8"),r.on("close",function(){n.write("</root>","utf8"),n.end()}),r.pipe(n,{end:!1})})}get promise(){return this._promise}changeDelegate(e){this._delegate=e}addTagDelegate(e,t){this._delegates[e]=t}appendStyle(e){this._style+=e}appendScript(e){this._script+=e}appendTemplate(e){if(this._template){const t=this._template;this._template=((s,i,n)=>t(s,i,n)+e(s,i,n))}else this._template=e}onError(e){console.error(e),process.exit()}onText(e){this._delegate&&this._delegate.onText(this,e)}onOpenTag(e){this._delegate||e.name in this._delegates&&(this._delegate=new this._delegates[e.name]),this._delegate&&this._delegate.onOpenTag(this,e)}onCloseTag(e){this._delegate&&this._delegate.onCloseTag(this,e)}onEnd(){}}class f{constructor(){this._stack=0,this._contents=""}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendStyle(this._contents),e.changeDelegate(null))}}class y{constructor(){this._stack=0,this._contents=""}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendScript(this._contents),e.changeDelegate(null))}}const T={">":"&gt;","<":"&lt;","'":"&apos;",'"':"&quot;","&":"&amp;"},b={"`":"\\`","\\":"\\\\",$:"\\$"},S="{{",x="}}",$="{#",w="#}";class C{constructor(){this._stack=0,this._closeTag=!0,this._ignore=!1,this._parsed="var $buf=[];with($locals=$locals||{}){$buf.push(`"}onText(e,t){this._ignore||(this._parsed+=this.parseText(t,n))}onOpenTag(e,t){if(++this._stack>1){this._closeTag=!t.isSelfClosing;const e=t.name.charAt(0);if(e!=e.toUpperCase()){let e="<"+r(t.name);for(let s in t.attributes)e+=" "+a(r(s))+'="'+this.parseText(t.attributes[s],r)+'"';t.isSelfClosing?e+="/>":e+=">",this._parsed+=e}else if("Styles"===t.name)this._ignore=!0,this._parsed+="</Styles/>";else if("Scripts"===t.name)this._ignore=!0,this._parsed+="</Scripts/>";else if("Children"===t.name)this._ignore=!0,this._parsed+="`,$children(),`";else{this._parsed+="`,$ins(`"+a(t.name)+"`,{";for(let e in t.attributes)this._parsed+="[`"+a(e)+"`]:"+this.parseAttribute(t.attributes[e])+",";this._parsed+="[`$children`]:function(){var $buf=[];$buf.push(`"}}}onCloseTag(e,t){if(this._stack>1){const e=t.charAt(0);e!=e.toUpperCase()?this._closeTag&&(this._parsed+="</"+r(t)+">"):"Styles"===t?this._ignore=!1:"Scripts"===t?this._ignore=!1:"Children"===t?this._ignore=!1:this._parsed+="`);return $buf.join(``);}}),`",this._closeTag=!0}0==--this._stack&&(this._parsed+="`)}return $buf.join(``);",e.appendTemplate(new Function("$esc","$ins","$locals",this._parsed)),e.changeDelegate(null))}parseText(e,t){function s(t){const s=e.indexOf(t,n);return s<0?i:s}const i=e.length;let n=0,r=s(S),o=s($),l="";for(;r<i||o<i;)if(r<o){l+=a(t(e.slice(n,r))),n=r+S.length;const i=s(x);l+="`,$esc("+e.slice(n,i)+"),`",n=i+x.length,r=s(S)}else{l+=a(t(e.slice(n,o))),n=o+$.length;const i=s(w);l+="`);"+e.slice(n,i)+";$buf.push(`",n=i+w.length,o=s($)}return l+=a(e.slice(n))}parseAttribute(e){function t(t){const n=e.indexOf(t,i);return n<0?s:n}const s=e.length;let i=0,n=t(S),o="";if(0===n&&t(x)===s-x.length)return"("+e.slice(S.length,-x.length)+")";for(;n<s;){o+=a(r(e.slice(i,n))),i=n+S.length;const s=t(x);o+="`+$esc("+e.slice(i,s)+")+`",i=s+x.length,n=t(S)}return"`"+(o+=a(e.slice(i)))+"`"}}class k extends m{constructor(e,t){super(e,t),this.addTagDelegate("style",f),this.addTagDelegate("script",y),this.addTagDelegate("template",C)}}class v extends o{constructor(e,t){super(),(t=t||{}).parser=t.parser||k,t.watch=t.watch||!1,this._modules={},this._watcher=null,h(e).then(e=>l.all(e.map(e=>new t.parser(this,e).promise.catch(t=>{this.emit("error",t,e)})))).then(i=>{if(i.forEach(e=>{this._modules[e.name]=e}),this.emit("done"),t.watch){const i=e=>{new t.parser(this,e).promise.then(e=>{this._modules[e.name]=e,this.emit("update",e)}).catch(t=>{this.emit("error",t,e)})},n=e=>{delete this._modules[s(e)]};this._watcher=c.watch(e,{ignoreInitial:!0}).on("add",i).on("change",i).on("unlink",n)}})}getRenderFunctions(e,t,s){const i={};return Object.entries(this._modules).forEach(([s,n])=>{i[s]=[n,n.template.bind(null,e,t)]}),i}stop(){this._watcher&&(this._watcher.close(),this._watcher=null)}}class q extends o{constructor(e,t,i){super(),(i=i||{}).escape=i.escape||r,i.minify=i.minify||!1,i.doctype=!1!==i.doctype,this._library=e,this._fileName=t,this._name=s(t);const n=()=>{function e(e,i){const[a,o]=t[e];return s[e]||(s[e]=!0,n+=a.style,r+=a.script),o(i)}const t=this._library.getRenderFunctions(i.escape,e),s={};let n="",r="",a=e(this._name,{});a=(a=a.replace("</Styles/>","<style>"+n+"</style>")).replace("</Scripts/>","<script>"+r+"<\/script>"),i.minify&&(a=g.minify(a,{collapseBooleanAttributes:!0,collapseWhitespace:!0,decodeEntities:!0,minifyCSS:!0,minifyJS:!0,quoteCharacter:'"',removeComments:!0,removeRedundantAttributes:!0,removeScriptTypeAttributes:!0,removeStyleLinkTypeAttributes:!0,sortAttributes:!0,sortClassName:!0,useShortDoctype:!0})),i.doctype&&(a="<!doctype html>"+a),this.emit("output",a)};e.on("done",n).on("update",n),this.stop=(()=>{e.removeListener("done",n).removeListener("update",n)})}}exports.Library=v,exports.Application=q;
