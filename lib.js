"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function t(e){return String(e).replace(/(^|-)(\w|$)/g,(e,t,s)=>s.toUpperCase())}function s(e){return t(u.parse(e).name)}function i(){return""}function r(e){return String(e)}function n(e){return String(e).replace(/[&"<>\']/g,e=>e in b?b[e]:e)}function a(e){return String(e).replace(/[`\\$]/g,e=>e in S?S[e]:e)}function o(e,t,s){return e.startsWith(t)&&e.endsWith(s)}Object.defineProperty(exports,"__esModule",{value:!0});var l=require("events"),h=require("bluebird"),c=require("chokidar"),p=e(require("globby")),u=require("path"),_=require("fs"),d=require("htmlparser2"),g=require("html-minifier");class m{constructor(e,t,i,r){this._fileName=e,this._name=s(e),this._style=t,this._script=i,this._template=r}get fileName(){return this._fileName}get name(){return this._name}get style(){return this._style}get script(){return this._script}get template(){return this._template}}class f{constructor(e,t){this._delegate=null,this._delegates={},this._style="",this._script="",this._template=null,this._promise=new h((e,s)=>{const r=new d.Parser({onerror:e=>{this.onError(e),s(e)},onopentag:(e,t)=>{this.onOpenTag(e,t)},onclosetag:e=>{this.onCloseTag(e)},ontext:e=>{this.onText(e)},onend:()=>{this.onEnd(),e(new m(t,this._style,this._script,this._template||i))}},{xmlMode:!1,decodeEntities:!1,lowerCaseTags:!1,lowerCaseAttributeNames:!1});_.createReadStream(u.resolve(t)).on("error",e=>{s(e)}).on("data",e=>{r.write(e)}).on("close",()=>{r.end()})})}get promise(){return this._promise}changeDelegate(e){this._delegate=e}addTagDelegate(e,t){this._delegates[e]=t}appendStyle(e){this._style+=e}appendScript(e){this._script+=e}appendTemplate(e){if(this._template){const t=this._template;this._template=((s,i,r)=>t(s,i,r)+e(s,i,r))}else this._template=e}onError(e){console.error(e),this._delegate&&this._delegate.onError(this,e)}onText(e){this._delegate&&this._delegate.onText(this,e)}onOpenTag(e,t){this._delegate||e in this._delegates&&(this._delegate=new this._delegates[e]),this._delegate&&this._delegate.onOpenTag(this,e,t)}onCloseTag(e){this._delegate&&this._delegate.onCloseTag(this,e)}onEnd(){}}class y{constructor(){this._stack=0,this._contents=""}onError(e,t){}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t,s){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendStyle(this._contents),e.changeDelegate(null))}}class T{constructor(){this._stack=0,this._contents=""}onError(e,t){}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t,s){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendScript(this._contents),e.changeDelegate(null))}}const b={">":"&gt;","<":"&lt;","'":"&apos;",'"':"&quot;","&":"&amp;"},S={"`":"\\`","\\":"\\\\",$:"\\$"},w="{{",$="}}",x="{#",C="#}";class k{constructor(){this._stack=0,this._closeTag=!0,this._ignore=!1,this._parsed="var $buf=[];with($locals=$locals||{}){$buf.push(`"}onError(e,t){}onText(e,t){this._ignore||(this._parsed+=this.parseText(t,r))}onOpenTag(e,t,s){if(++this._stack>1){const e=t.charAt(0);if(e!=e.toUpperCase()){let e="<"+n(t);for(let t in s)e+=" "+a(n(t))+'="'+this.parseText(s[t],n)+'"';this._parsed+=e+">"}else if("Styles"===t)this._ignore=!0,this._parsed+="</Styles/>";else if("Scripts"===t)this._ignore=!0,this._parsed+="</Scripts/>";else if("Children"===t)this._ignore=!0,this._parsed+="`,$children(),`";else{this._parsed+="`,$ins(`"+a(t)+"`,{";for(let e in s)this._parsed+=this.parseAttribute(e,s[e]);this._parsed+="[`$children`]:function(){var $buf=[];$buf.push(`"}}}onCloseTag(e,t){if(this._stack>1){const e=t.charAt(0);e!=e.toUpperCase()?this._closeTag&&(this._parsed+="</"+n(t)+">"):"Styles"===t?this._ignore=!1:"Scripts"===t?this._ignore=!1:"Children"===t?this._ignore=!1:this._parsed+="`);return $buf.join(``);}}),`",this._closeTag=!0}0==--this._stack&&(this._parsed+="`)}return $buf.join(``);",e.appendTemplate(new Function("$esc","$ins","$locals",this._parsed)),e.changeDelegate(null))}parseText(e,t){function s(t){const s=e.indexOf(t,r);return s<0?i:s}const i=e.length;let r=0,n=s(w),o=s(x),l="";for(;n<i||o<i;)if(n<o){l+=a(t(e.slice(r,n))),r=n+w.length;const i=s($);l+="`,$esc("+e.slice(r,i)+"),`",r=i+$.length,n=s(w)}else{l+=a(t(e.slice(r,o))),r=o+x.length;const i=s(C);l+="`);"+e.slice(r,i)+";$buf.push(`",r=i+C.length,o=s(x)}return l+=a(e.slice(r))}parseAttribute(e,t){return o(e,w,$)&&""===t?"..."+e.slice(w.length,-$.length)+",":"[`"+a(e)+"`]:"+this.parseAttributeValue(t)+","}parseAttributeValue(e){function t(t){const r=e.indexOf(t,i);return r<0?s:r}const s=e.length;let i=0,r=t(w),l="";if(o(e,w,$))return"("+e.slice(w.length,-$.length)+")";for(;r<s;){l+=a(n(e.slice(i,r))),i=r+w.length;const s=t($);l+="`+$esc("+e.slice(i,s)+")+`",i=s+$.length,r=t(w)}return"`"+(l+=a(e.slice(i)))+"`"}}class A extends f{constructor(e,t){super(e,t),this.addTagDelegate("style",y),this.addTagDelegate("script",T),this.addTagDelegate("template",k)}}class v extends l{constructor(e,t){super(),(t=t||{}).parser=t.parser||A,t.watch=t.watch||!1,this._modules={},this._watcher=null,p(e).then(e=>h.all(e.map(e=>new t.parser(this,e).promise.catch(t=>{this.emit("error",t,e)})))).then(i=>{if(i.forEach(e=>{this._modules[e.name]=e}),this.emit("done"),t.watch){const i=e=>{new t.parser(this,e).promise.then(e=>{this._modules[e.name]=e,this.emit("update",e)}).catch(t=>{this.emit("error",t,e)})},r=e=>{delete this._modules[s(e)]};this._watcher=c.watch(e,{ignoreInitial:!0}).on("add",i).on("change",i).on("unlink",r)}})}getRenderFunctions(e,t,s){const i={};return Object.entries(this._modules).forEach(([s,r])=>{i[s]=[r,r.template.bind(null,e,t)]}),i}stop(){this._watcher&&(this._watcher.close(),this._watcher=null)}}class E extends l{constructor(e,t,i){super(),(i=i||{}).escape=i.escape||n,i.minify=i.minify||!1,i.doctype=!1!==i.doctype,i.data=i.data||{},this._library=e,this._fileName=t,this._name=s(t);const r=()=>{function e(e,i){const[a,o]=t[e];return s[e]||(s[e]=!0,r+=a.style,n+=a.script),o(i)}const t=this._library.getRenderFunctions(i.escape,e),s={};let r="",n="",a=e(this._name,i.data);a=(a=a.replace("</Styles/>","<style>"+r+"</style>")).replace("</Scripts/>","<script>"+n+"<\/script>"),i.minify&&(a=g.minify(a,{collapseBooleanAttributes:!0,collapseWhitespace:!0,decodeEntities:!0,minifyCSS:!0,minifyJS:!0,quoteCharacter:'"',removeComments:!0,removeRedundantAttributes:!0,removeScriptTypeAttributes:!0,removeStyleLinkTypeAttributes:!0,sortAttributes:!0,sortClassName:!0,useShortDoctype:!0})),i.doctype&&(a="<!doctype html>"+a),this.emit("output",a)};e.on("done",r).on("update",r),this.stop=(()=>{e.removeListener("done",r).removeListener("update",r)})}}exports.Library=v,exports.Application=E;
