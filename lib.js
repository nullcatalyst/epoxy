"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function t(e){return String(e)}function s(e){return String(e).replace(/[&"<>\']/g,e=>e in d?d[e]:e)}function i(e){return String(e).replace(/[`\\$]/g,e=>e in g?g[e]:e)}function n(e){return String(e).replace(/(^|-)(\w|$)/g,(e,t,s)=>s.toUpperCase())}function r(){return""}Object.defineProperty(exports,"__esModule",{value:!0});var a=require("events"),o=require("bluebird"),l=require("chokidar"),c=e(require("globby")),h=require("path"),p=require("fs"),u=require("sax"),_=require("html-minifier");const d={">":"&gt;","<":"&lt;","'":"&apos;",'"':"&quot;","&":"&amp;"},g={"`":"\\`","\\":"\\\\",$:"\\$"};class m{static fileNameToModuleName(e){return n(h.parse(e).name)}constructor(e,t,s,i){this._fileName=e,this._name=m.fileNameToModuleName(e),this._style=t,this._script=s,this._template=i}get fileName(){return this._fileName}get name(){return this._name}get style(){return this._style}get script(){return this._script}get template(){return this._template}}class f{constructor(e,t){this._delegate=null,this._delegates={},this._style="",this._script="",this._template=null,this._promise=new o((e,s)=>{const i=u.createStream(!0,{trim:!1,normalize:!1,lowercase:!1,xmlns:!1,position:!0});i.on("error",e=>{this.onError(e),s(e)}),i.on("opentag",e=>this.onOpenTag(e)),i.on("closetag",e=>this.onCloseTag(e)),i.on("text",e=>this.onText(e)),i.on("end",()=>{this.onEnd(),e(new m(t,this._style,this._script,this._template||r))});const n=p.createReadStream(h.resolve(t));i.write("<root>","utf8"),n.on("close",function(){i.write("</root>","utf8"),i.end()}),n.pipe(i,{end:!1})})}get promise(){return this._promise}changeDelegate(e){this._delegate=e}addTagDelegate(e,t){this._delegates[e]=t}appendStyle(e){this._style+=e}appendScript(e){this._script+=e}appendTemplate(e){if(this._template){const t=this._template;this._template=((s,i,n)=>t(s,i,n)+e(s,i,n))}else this._template=e}onError(e){console.error(e),process.exit()}onText(e){this._delegate&&this._delegate.onText(this,e)}onOpenTag(e){this._delegate||e.name in this._delegates&&(this._delegate=new this._delegates[e.name]),this._delegate&&this._delegate.onOpenTag(this,e)}onCloseTag(e){this._delegate&&this._delegate.onCloseTag(this,e)}onEnd(){}}class T{constructor(){this._stack=0,this._contents=""}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendStyle(this._contents),e.changeDelegate(null))}}class y{constructor(){this._stack=0,this._contents=""}onText(e,t){1==this._stack&&(this._contents+=t)}onOpenTag(e,t){++this._stack}onCloseTag(e,t){0==--this._stack&&(e.appendScript(this._contents),e.changeDelegate(null))}}const b="{{",S="}}",x="{#",$="#}";class w{constructor(){this._stack=0,this._closeTag=!0,this._ignore=!1,this._parsed="var $buf=[];with($locals=$locals||{}){$buf.push(`"}onText(e,s){this._ignore||(this._parsed+=this.parseText(s,t))}onOpenTag(e,t){if(++this._stack>1){this._closeTag=!t.isSelfClosing;const e=t.name.charAt(0);if(e!=e.toUpperCase()){let e="<"+s(t.name);for(let n in t.attributes)e+=" "+i(s(n))+'="'+this.parseText(t.attributes[n],s)+'"';t.isSelfClosing?e+="/>":e+=">",this._parsed+=e}else if("Styles"===t.name)this._ignore=!0,this._parsed+="</Styles/>";else if("Scripts"===t.name)this._ignore=!0,this._parsed+="</Scripts/>";else if("Children"===t.name)this._ignore=!0,this._parsed+="`,$children(),`";else{this._parsed+="`,$ins(`"+i(t.name)+"`,{";for(let e in t.attributes)this._parsed+="[`"+i(e)+"`]:"+this.parseAttribute(t.attributes[e])+",";this._parsed+="[`$children`]:function(){var $buf=[];$buf.push(`"}}}onCloseTag(e,t){if(this._stack>1){const e=t.charAt(0);e!=e.toUpperCase()?this._closeTag&&(this._parsed+="</"+s(t)+">"):"Styles"===t?this._ignore=!1:"Scripts"===t?this._ignore=!1:"Children"===t?this._ignore=!1:this._parsed+="`);return $buf.join(``);}}),`",this._closeTag=!0}0==--this._stack&&(this._parsed+="`)}return $buf.join(``);",e.appendTemplate(new Function("$esc","$ins","$locals",this._parsed)),e.changeDelegate(null))}parseText(e,t){function s(t){const s=e.indexOf(t,r);return s<0?n:s}const n=e.length;let r=0,a=s(b),o=s(x),l="";for(;a<n||o<n;)if(a<o){l+=i(t(e.slice(r,a))),r=a+b.length;const n=s(S);l+="`,$esc("+e.slice(r,n)+"),`",r=n+S.length,a=s(b)}else{l+=i(t(e.slice(r,o))),r=o+x.length;const n=s($);l+="`);"+e.slice(r,n)+";$buf.push(`",r=n+$.length,o=s(x)}return l+=i(e.slice(r))}parseAttribute(e){function t(t){const s=e.indexOf(t,r);return s<0?n:s}const n=e.length;let r=0,a=t(b),o="";if(0===a&&t(S)===n-S.length)return"("+e.slice(b.length,-S.length)+")";for(;a<n;){o+=i(s(e.slice(r,a))),r=a+b.length;const n=t(S);o+="`+$esc("+e.slice(r,n)+")+`",r=n+S.length,a=t(b)}return"`"+(o+=i(e.slice(r)))+"`"}}class C extends f{constructor(e,t){super(e,t),this.addTagDelegate("style",T),this.addTagDelegate("script",y),this.addTagDelegate("template",w)}}class k extends a{constructor(e,t){super(),(t=t||{}).parser=t.parser||C,t.watch=t.watch||!1,this._modules={},this._watcher=null,c(e).then(e=>o.all(e.map(e=>new t.parser(this,e).promise.catch(t=>{this.emit("error",t,e)})))).then(s=>{if(s.forEach(e=>{this._modules[e.name]=e}),this.emit("done"),t.watch){const s=e=>{new t.parser(this,e).promise.then(e=>{this._modules[e.name]=e,this.emit("update",e)}).catch(t=>{this.emit("error",t,e)})},i=e=>{delete this._modules[m.fileNameToModuleName(e)]};this._watcher=l.watch(e,{ignoreInitial:!0}).on("add",s).on("change",s).on("unlink",i)}})}getRenderFunctions(e,t,s){const i={};return Object.entries(this._modules).forEach(([s,n])=>{i[s]=[n,n.template.bind(null,e,t)]}),i}stop(){this._watcher&&(this._watcher.close(),this._watcher=null)}}class N extends a{constructor(e,t,i){super(),(i=i||{}).escape=i.escape||s,i.minify=i.minify||!1,i.doctype=!1!==i.doctype,this._library=e,this._fileName=t,this._name=m.fileNameToModuleName(t);const n=()=>{function e(e,i){const[a,o]=t[e];return s[e]||(s[e]=!0,n+=a.style,r+=a.script),o(i)}const t=this._library.getRenderFunctions(i.escape,e),s={};let n="",r="",a=e(this._name,{});a=(a=a.replace("</Styles/>","<style>"+n+"</style>")).replace("</Scripts/>","<script>"+r+"<\/script>"),i.minify&&(a=_.minify(a,{collapseBooleanAttributes:!0,collapseWhitespace:!0,decodeEntities:!0,minifyCSS:!0,minifyJS:!0,quoteCharacter:'"',removeComments:!0,removeRedundantAttributes:!0,removeScriptTypeAttributes:!0,removeStyleLinkTypeAttributes:!0,sortAttributes:!0,sortClassName:!0,useShortDoctype:!0})),i.doctype&&(a="<!doctype html>"+a),this.emit("output",a)};e.on("done",n).on("update",n)}}exports.Library=k,exports.Application=N;
